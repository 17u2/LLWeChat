# LLWeChat 1.0
**说明：下载项目请下载stable分支，不要下载master分支**

##雕琢细节
要想媲美微信，就必须要雕琢细节，在细节上下功夫，做到位。否则细节上马马虎虎，媲美微信就是一句空话。

###（一）、消息输入
####1、输入面板基本功能<br/>

<img src="ScreenShot/输入面板基本功能.PNG" width="304"><br/>

####2、输入框动态调整高度
* 细节1：当行数增加、减少时，做出动画，而不是一步到位。
* 细节2：除非用户滚动文本，否则文本编辑时不允许出现某一行只漏出一部分。

![](ScreenShot/输入框动态调整高度.gif "输入框动态调整高度")

####3、草稿
当一个会话有草稿时，应该在会话push动画开始时就完成如下工作：<br/>读取最新13条消息，解析消息，获取消息缩略图，布局输入框并显示草稿最后一行，弹出键盘（尤其是第三方键盘），布局TableView。<br/>当首次进入会话时，如何高效完成这些工作是一个很大的挑战。我花费了许多力气，但还是不太满意。<br/>

![](ScreenShot/输入框草稿.gif "输入框草稿")


###(二）、GIF
* 细节1：内存大小。把GIF转成imageView，内存会暴涨，不可行。只能播一帧获取一帧图片
* 细节2：重用。GIF快速重用时，因为是后台获取帧图片需要处理好同步，还得记住播放进度，以便重用回来的时候继续播放<br/>

<img src="ScreenShot/GIF.PNG" width="304"><br/>

###（三）、文本
* 细节1：文本中包含的链接有三个行为：点击、长按、高亮。高亮要细心处理，否则效果会很糟糕：滚动文本触及了链接不高亮，点击链接必高亮，高亮后依然允许滚动，触发滚动取消高亮等
* 细节2：文本全屏浏览的触发方式（下面有说明），全屏浏览进入退出时的动画。
* 细节3：AppleSDK识别文本中URL不太精确，需要自己提供正则式，暂未实现。

####1、文本链接

![](ScreenShot/文本链接.gif "文本链接")


###（四）、地图
* 细节1：地图附近POI搜索，我想根据用户位置、当前时间等做推荐式搜索，暂未实现。
* 细节2：点击地图Cell后要支持侧滑返回，系统默认的NavigationBar交互式返回动画效果不太好，但也可以接受。

####1、地图基本功能

![](ScreenShot/地图1.gif "地图1")

####2、地图搜索

![](ScreenShot/地图搜索.gif "地图搜索")


###（五）、ImagePicker
ImagePicker做了PhotoKit和AssetLibrary适配
* 细节1：整个ImagePicker的核心就是决定一张照片获取方式是同步还是异步，照片质量是fullScreen还是fullResolution；<br/>AssetLibrary框架要自己决定， 而PhotoKit框架替你做了一部分。
* 细节2：需要考虑照片或视频已经被用户删除的情况，这时选择、全屏浏览、发送要特殊处理下

####1、照片浏览

![](ScreenShot/照片浏览.gif "照片浏览")

####2、照片发送

![](ScreenShot/照片发送.gif "照片发送")

####3、视频发送

![](ScreenShot/视频发送.gif "视频发送")


###（六）、照片视频浏览
* 细节1：长照片弹出弹入动画，在ImageView做Frame动画的同时，其包含的image也会从当前偏移位置滚动到目标偏移位置。
* 细节2：视频使用AVPlayer播放，而AVPlayer需要占用主线程，使得快速浏览时明显卡顿，我的解决方法就是用视频第一帧图片代替视频滚动，滚动结束时关联AVPlayer和VideoURL，当用户点击播放按钮或拖动进度条时把图片换成真正的视频。
* 细节3：适应屏幕旋转。特别当用户在设备水平朝向时，点击返回。需要先把照片视频旋转到竖立方向，然后再做弹出动画。
* 细节4：照片视频浏览时的bottomBar的切换，照片视频下载状态的更新，这块规则很多很杂，不列举了

####1、照片视频弹入弹出动画

![](ScreenShot/照片视频弹入弹出动画.gif "照片视频弹入弹出动画")

####2、视频下载

![](ScreenShot/视频下载.gif "视频下载")


###（七）、语音
* 细节1：按压录音按钮小于0.25秒， 弹录音太短Tip，大于则变按钮title为“松开 结束”同时录音开始；小于1.25秒，弹录音太短Tip；大于1.25秒出现录音动画，此时录音时长刚好1秒。51秒时弹倒计时，60秒时强制结束录音并取消录音按钮按压事件。
* 细节2：录音时APP进入后台，则结束并发送录音。再返回APP时，录音按钮第一次点击无效，不清楚原因，暂未解决。
* 细节3：播放录音有：音量太低Tip，播放模式切换，未读声音联播等

####1、语音录制

<img src="ScreenShot/录音.PNG" width="304"><br/>

####2、录音最大时长

![](ScreenShot/录音最大时长.gif "录音最大时长")



###（八）、缓存
####1、MessageCell缓存
* GIF、日期消息只重用，不缓存
* 整个APP默认缓存MessageCell `1300条`，超出的消息采用TableView重用机制
* 退出当前会话后，保留会话最近MessageCell `130条`
* 自定义数值，可在`LLMessageCellManager`中更改

####2、照片、视频缩略图
* 本项目没有采用环信SDK提供的缩略图，而是APP负责缩略图的创建、存储、删除
* 照片、视频MessageCell不可见时就清空缩略图，可见时再读取缩略图
* 为了加快缩略图读取，内存中默认缓存缩略图上限`80M`
* APP运行时会把一段时间内未读取过的缩略图从硬盘上删除
* 自定义数值可在`LLMessageThumbnailManager`中更改


###（九）、其他
其他界面只实现了最简单的功能

####1、批量删除
* 细节1：弹出的ActionSheet在键盘之上<br/>
![](ScreenShot/批量删除.gif "批量删除")

####2、添加好友
![](ScreenShot/添加好友.gif "添加好友") 

####3、消息搜索
![](ScreenShot/消息搜索.gif "消息搜索")

####4、新消息通知
![](ScreenShot/新消息通知.gif "新消息通知")



##项目基本信息
* 开发语言：Objective-C
* 最低部署版本：IOS8.0，（开发版本IOS9.3）
* 手机适配：iPhone6 plus最好，iPhone6次之。其他机型没有兼顾到



##第三方库
* 环信SDK（`71M`），已包含在项目中
* 高德SDK（`15.6M`），已包含在项目中
* MBProgressHUD，已包含在项目中
* Github下载项目Zip包大小：`40M`



##项目安装
1、切换到`Podfile`文件所在目录，运行  `pod install` （当前版本Podfile内容为空）<br/>
2、使用高德地图，请到[高德官网注册APP Key](http://lbs.amap.com/console/key)，然后替换掉`LLGDConfig.h`头文件中APPKey即可。<br/>
      注册步骤为：注册成为开发者->点击右上角控制台->我的应用->创建新应用 <br/>
3、运行`LLWeChat.xcworkspace`  <br/>



##项目目录
|目录 | 说明|
| ---------- | -----------|
| General | 该目录包含和项目耦合性最低的通用模块，包括声音管理器、照片选取器、通用UI、Utilities等 |
| Server | 该目录封装环信SDK，环信SDK一共封装成四个类：<br/> 1、LLClientManager：管理用户的注册、登陆、登出等 <br/>2、LLChatManager：管理会话消息的收发、本地消息的加载更新等<br/>3、LLContactManager： 管理好友列表<br/>4、LLSDKError：环信SDK错误码的封装|
| Data | 数据目录，包括Config、Cache、Model等 |
| Client | 该目录是项目的主体，按照业务功能分类，分为会话、聊天、搜索、通讯录、设置等|
**Server、Data可以直接访问SDK，Client代码不允许直接访问环信SDK，要把环信SDK和Client完全隔离开**



##产品设计
###（一）、单击全屏浏览文本
这个项目中文本点击进入全屏，使用一段时间后感觉很自然，很得劲；而双击则感觉有点笨重。<br/>
如果喜欢双击模式，可以在“设置--通用”里面更改

图片单击放大，视频单击播放，声音也是单击播放，地图点击，gif也是单击<br>
也就是说单击是一种查看消息详情的触发方式，而文本消息的详细模式就是全屏浏览<br>
文本采用单击触发，而不是双击的理由：<br>

1. 单击触发文本全屏浏览，会和其他类型的消息触发方式一致
* 单击比起双击更易操作，鼠标双击还可以接受，用手指双击体验不好
* 用户意识到文本也和图片、视频、声音一样单击触发后，文本误操作概率不会高于其他类型Cell
* 文本内电话、URL、邮件、控制字符串等可点击区域造成的干扰很小
* 鼓励全屏查看文本，可以有更好的浏览体验，同时也可以提供更多的功能
* 如果实在众口难调，在设置--通用里面加个“单击、双击”的切换开关即可

###（二）、改进输入框——细节待定
为什么输入框要限制为5行？，是因为80-90%的消息长度不足5行，还是纯粹为了美观，还是用户在输入消息时需要实时查看历史消息？<br/>
输入框可以更宽更高，字体可以更大更宽松 <br/>

###（三）、所有消息参与卡片式浏览——细节待定
现在只有图片、视频、小视频参与卡片式浏览，如果鼓励全屏浏览文本，那么就必须实现文本的卡片式浏览；<br/>
在群聊中，往往对某些人更感兴趣，比如活动组织者。我想做成左右滑动正常浏览，上下滑动则只浏览当前消息发送者的历史消息，<br/>
总之，左右滑动是群聊， 上下滑动相当于单聊。

###(四）、消息缩略图
我想要下面的效果： <br/>

####1、消息本身自带缩略图，而不是客户端收到消息后再去下载缩略图。
`目前做法`：消息收到后先显示一个默认图片，等待缩略图下载完毕后再替换默认图片，这种行为我非常不喜欢。<br/>
我曾经为了解决这个问题，在客户端收到消息后延迟派发直到缩略图下载完毕，不过最后细节不好处理放弃了。<br/>
`希望做法`：我希望消息本身就自带一个缩略图，哪怕这个缩略图非常粗糙，只要大体看出点眉目即可。

####2、APP自动下载高清缩略图
`目前做法`：现在收到消息后要想显示高清缩略图必须下载照片原图后，APP自己生成一个高清缩略图。<br/>
`希望做法`：APP主动下载消息高质量缩略图，没有必要下载原图。用户根据高清缩略图来决定自己是不是感兴趣 <br/>

####3、用户主动下载照片原图
唯有当用户主动点击照片后，才开始下载照片原图。<br/>

当然不是每一个照片都要分为三个形态分别下载，一般照片，高清缩略图和原图可以合二为一，直接下载原图即可。 <br/>



##下个版本
下个版本实现如下功能：  
1、小视频<br/>
2、语音、视频通话<br/>
3、消息搜索、上拉刷新<br/>
4、群聊<br/>
5、通讯录<br/>
***
6、国际化，iPhone、iPad全版本适配，操作声效 、IOS版本适配（可能不做）<br/>
7、日志、奔溃、统计等 （可能不做）



##Licenses
本项目所有LL-开头的源码遵守MIT license. 
本项目绝大部分资源归腾讯公司所有
